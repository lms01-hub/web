<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ë­í‚¹ (Top 50)</title>
<style>
:root {
    --max-w: 600px; /* ìµœëŒ€ ê°€ë¡œí­ 600px ì œí•œ */
}

body {
    margin: 0;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    background: #f6f7fb;
    color: #222;
}

.wrap {
    margin: 0 auto;
    padding: 24px 16px 48px;
}

.header {
    max-width: var(--max-w);
    margin: 0 auto 16px;
    display: flex;
    align-items: center;
    gap: 12px;
}

.title {
    font-weight: 800;
    font-size: 20px;
    letter-spacing: 0.3px;
}

.sub {
    color: #666;
    font-size: 12px;
}

.card {
    max-width: var(--max-w);
    margin: 0 auto;
    background-color: #fff;
    border-radius: 14px;
    overflow: hidden;
}

.toolbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    padding: 12px 14px;
    border-bottom: 1px solid #eee;
    background: #fafafa;
}

.btn {
    appearance: none;
    border: 0;
    padding: 8px 12px;
    border-radius: 10px;
    background: #2d6cdf;
    color: #fff;
    font-weight: 700;
    cursor: pointer;
}
.btn:active {
    transform: translateY(1px);
}

.ghost {
    background: #e9eefc;
    color: #1b3ea3;
}

.table-wrap {
    width: 100%;
    overflow-x: auto;
}

table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
}

thead th {
    position: sticky;
    top: 0;
    background: #f3f6ff;
    color: #1b3ea3;
    font-weight: 800;
    text-align: left;
    padding: 12px 10px;
    border-bottom: 1px solid #f0f0f0;
    z-index: 1;
}

tbody td {
    padding: 12px 10px;
    border-bottom: 1px solid #f0f0f0;
    white-space: nowrap;
}

tbody tr:nth-child(odd) {
    background: #fcfcff;
}
tbody tr:hover {
    background: #f2f7ff;
}

.rank {
    font-weight: 900;
    font-size: 22px;
    width: 76px;
    letter-spacing: 0.2px;
}

.rank.top1 { color: #d97706; }
.rank.top2 { color: #6b7280; }
.rank.top3 { color: #b45309; }

tr.row-1 { background: #fff2cc !important; }
tr.row-2 { background: #fce8e6 !important; }
tr.row-3 { background: #e7f3ff !important; }
tr.row-4 { background: #e9f7ef !important; }
tr.row-5 { background: #f3e8ff !important; }
tr.row-6 { background: #fff0f6 !important; }
tr.row-7 { background: #e6fffb !important; }
tr.row-8 { background: #f0f4ff !important; }
tr.row-9 { background: #f9fbe7 !important; }
tr.row-10 { background: #fef7ff !important; }

.hl { background: #fff7cc !important; }

.footer {
    max-width: var(--max-w);
    margin: 14px auto 0;
    color: #666;
    font-size: 12px;
    line-height: 1.4;
    padding: 0 2px;
}

@media (min-width: 769px) {.wrap { width: var(--max-w); }}
@media (max-width: 768px) {.wrap { width: 100%; }}
.game-title{
    text-align: center;
    font-size: 36px;
    font-weight: 900;
    color: #1b3ea3;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    margin-top: 16px;
    margin-bottom: 8px;
    letter-spacing: 2px;
    font-family: 'Trebuchet MS','Noto Sans KR',sans-serif;
}
@media (max-width:768px){
    .game-title{
        font-size: 28px;
    }
}

</style>
</head>
<body>
    <div class="game-title">â°ìŠ¤í€˜ì–´ íƒ€ì„ëŸ°â°</div>
<div class="wrap">
    <div class="header">
        <div>
            <div class="title">ğŸ† ë­í‚¹ TOP 50</div>
            <div class="sub">ê¸°ë¡ì´ ì‘ì„ìˆ˜ë¡ ë” ë†’ì€ ìˆœìœ„ì˜ˆìš” (ë‹¨ìœ„: ì´ˆ)</div>
        </div>
    </div>

    <div class="card">
        <div class="toolbar">
            <button class="btn ghost" id="btnRefresh">ìƒˆë¡œê³ ì¹¨</button>
            <button class="btn" id="btnBack">ê²Œì„ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>

        <div class="table-wrap">
            <table aria-label="ë­í‚¹ í‘œ">
                <thead>
                    <tr>
                        <th class="rank">ìˆœìœ„</th>
                        <th>ì•„ì´ë””</th>
                        <th>ê¸°ë¡(ì´ˆ)</th>
                        <th>ì €ì¥ì‹œê°</th>
                    </tr>
                </thead>
                <tbody id="rankBody">
                    <tr><td colspan="4">ë¶ˆëŸ¬ì˜¤ëŠ”ì¤‘...</td></tr>
                </tbody>
            </table>    
        </div>
    </div>

    <div class="footer">
        * ë™ì ì¼ ê²½ìš° ì €ì¥ ìˆœì„œë¡œ ì •ë ¬ë  ìˆ˜ ìˆì–´ìš”.<br/>
        * ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œëŠ” Firestore ë³´ì•ˆ ê·œì¹™ì„ ê¼­ ì ìš©í•´ì•¼ í•´ìš”.
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/12.3.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore-compat.js"></script>

<script>
var firebaseConfig = {
    apiKey: "AIzaSyDdjYf_8gLtqSnCtfgj_sZ4w1Bh2JVQTHM",
    authDomain: "my-webgame-project1-f4e1b.firebaseapp.com",
    projectId: "my-webgame-project1-f4e1b",
    storageBucket: "my-webgame-project1-f4e1b.firebasestorage.app",
    messagingSenderId: "143089634435",
    appId: "1:143089634435:web:e5ee71a77d74a071a99fb6"
};

firebase.initializeApp(firebaseConfig);
var db = firebase.firestore();

// âœ… getQueryParam í•¨ìˆ˜ ì˜¤ë¥˜ ìˆ˜ì •
function getQueryParam(name) {
    var query = location.search.replace(/^\?/, '');
    var parts = query.split('&');
    for (var i = 0; i < parts.length; i++) { // part â†’ parts
        var kv = parts[i].split('=');
        if (decodeURIComponent(kv[0]) === name) { // --- â†’ ===
            return kv[1] ? decodeURIComponent(kv[1]) : '';
        }
    }
    return null;
}

var lastId = getQueryParam('lastId');
var lastTime = getQueryParam('lastTime');

function to2(n) {
    if (typeof n !== 'number' || !isFinite(n)) return '';
    return (Math.round(n * 100) / 100).toFixed(2);
}

function fmtDate(ts) {
    if (!ts || !ts.toDate) return '';
    var d = ts.toDate();
    var y = d.getFullYear();
    var m = d.getMonth() + 1;
    var day = d.getDate();
    var hh = d.getHours();
    var mm = d.getMinutes();

    if (m < 10) m = '0' + m;
    if (day < 10) day = '0' + day;
    if (hh < 10) hh = '0' + hh;
    if (mm < 10) mm = '0' + mm;

    return y + '-' + m + '-' + day + ' ' + hh + ':' + mm;
}

// âœ… HTML escape ì˜¤ë¥˜ ìˆ˜ì •
function escapeHtml(s) {
    s = String(s);
    return s
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
}

// âœ… Firestore ë­í‚¹ ë¡œë“œ
function loadRanking() {
    var body = document.getElementById('rankBody');
    body.innerHTML = '<tr><td colspan="4">ë¶ˆëŸ¬ì˜¤ëŠ”ì¤‘...</td></tr>';

    db.collection('scores')
        .orderBy('time', 'asc')
        .limit(50)
        .get()
        .then(function(snapshot) {
            var html = '';
            var rank = 0;

            snapshot.forEach(function(doc) { // âœ… ê´„í˜¸ ì˜¤ë¥˜ ìˆ˜ì •
                var data = doc.data() || {};
                var userId = data.userId || '';
                var time = Number(data.time);
                var createdAt = data.createdAt || null;

                rank++;

                var medal = '';
                if (rank === 1) medal = 'ğŸ¥‡ ';
                else if (rank === 2) medal = 'ğŸ¥ˆ ';
                else if (rank === 3) medal = 'ğŸ¥‰ ';

                var rowClass = '';
                if (rank <= 10) rowClass = 'row-' + rank;

                var isHL = false;
                if (lastId !== null && lastTime !== null) {
                    if (String(userId) === String(lastId) && to2(Number(time)) === to2(Number(lastTime))) {
                        isHL = true;
                    }
                }

                var rankClass = '';
                if (rank === 1) rankClass = 'top1';
                else if (rank === 2) rankClass = 'top2';
                else if (rank === 3) rankClass = 'top3';

                html += '<tr class="' + (isHL ? 'hl ' : '') + rowClass + '">';
                html += '<td class="rank ' + rankClass + '">' + medal + rank + '</td>';
                html += '<td>' + escapeHtml(userId) + '</td>';
                html += '<td>' + to2(time) + '</td>';
                html += '<td>' + fmtDate(createdAt) + '</td>';
                html += '</tr>';
            });

            if (html === '') {
                body.innerHTML = '<tr><td colspan="4">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            } else {
                body.innerHTML = html;
            }
        })
        .catch(function(err) {
            console.error(err);
            body.innerHTML = '<tr><td colspan="4" style="color:#c00;">ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•˜ì„¸ìš”.</td></tr>';
        });
}

// âœ… ë²„íŠ¼ ì˜¤íƒ€ ìˆ˜ì • (btnBank â†’ btnBack)
document.getElementById('btnRefresh').onclick = function() {
    loadRanking();
};
document.getElementById('btnBack').onclick = function() {
    location.href = "canvas_js_exam_1_12.html";
};

loadRanking();
</script>
</body>
</html>
